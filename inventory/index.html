<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Electronics Inventory - Samuel Lamb">
  <title>Electronics Inventory - Samuel Lamb</title>

  <!-- Font Awesome Icons -->
  <link href="../vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather+Sans:400,700" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic' rel='stylesheet' type='text/css'>
  <!-- Plugin CSS -->
  <link href="../vendor/magnific-popup/magnific-popup.css" rel="stylesheet">
  <!-- Theme CSS - Includes Bootstrap -->
  <link href="../css/creative.min.css" rel="stylesheet">
  <!-- Custom Dark Mode CSS -->
  <link href="../css/custom-dark-mode.css" rel="stylesheet">
  
  <style>
    /* Inventory-specific styles */
    .inventory-section {
      margin-top: 100px;
      min-height: 80vh;
      padding: 2rem 0;
    }
    
    .inventory-header {
      margin-bottom: 2rem;
    }
    
    .inventory-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background-color: var(--section-bg-light);
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .inventory-filters input,
    .inventory-filters select {
      padding: 0.5rem 0.75rem;
      border-radius: 0.25rem;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .inventory-filters input:focus,
    .inventory-filters select:focus {
      outline: none;
      border-color: #f4623a;
      box-shadow: 0 0 0 0.2rem rgba(244, 98, 58, 0.25);
    }
    
    body.dark-mode .inventory-filters input:focus,
    body.dark-mode .inventory-filters select:focus {
      border-color: #ff8c42;
      box-shadow: 0 0 0 0.2rem rgba(255, 140, 66, 0.25);
    }
    
    .inventory-filters input {
      flex: 1;
      min-width: 200px;
    }
    
    .inventory-filters select {
      min-width: 150px;
    }
    
    .inventory-actions {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .btn-export,
    .btn-home {
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      border: none;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-export {
      background-color: #f4623a;
      color: white;
    }
    
    .btn-export:hover {
      background-color: #e55a2e;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(244, 98, 58, 0.3);
    }
    
    body.dark-mode .btn-export {
      background-color: #ff8c42;
    }
    
    body.dark-mode .btn-export:hover {
      background-color: #ff7a2e;
      box-shadow: 0 4px 8px rgba(255, 140, 66, 0.3);
    }
    
    .btn-home {
      background-color: var(--section-bg-light);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    
    .btn-home:hover {
      background-color: var(--border-color);
      transform: translateY(-2px);
    }
    
    .btn-add {
      background-color: #28a745;
      color: white;
    }
    
    .btn-add:hover {
      background-color: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }
    
    body.dark-mode .btn-add {
      background-color: #34ce57;
    }
    
    body.dark-mode .btn-add:hover {
      background-color: #2eb84a;
    }
    
    .add-item-modal .modal-content {
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    
    .add-item-modal .form-control {
      background-color: var(--card-bg);
      color: var(--text-color);
      border-color: var(--border-color);
    }
    
    .add-item-modal .form-control:focus {
      background-color: var(--card-bg);
      color: var(--text-color);
      border-color: #f4623a;
      box-shadow: 0 0 0 0.2rem rgba(244, 98, 58, 0.25);
    }
    
    body.dark-mode .add-item-modal .form-control:focus {
      border-color: #ff8c42;
      box-shadow: 0 0 0 0.2rem rgba(255, 140, 66, 0.25);
    }
    
    .add-item-modal label {
      color: var(--text-color);
      font-weight: 500;
    }
    
    .other-input-wrapper {
      margin-top: 0.5rem;
      display: none;
    }
    
    .other-input-wrapper.show {
      display: block;
    }
    
    .other-input-wrapper input {
      border-left: 3px solid #f4623a;
    }
    
    body.dark-mode .other-input-wrapper input {
      border-left-color: #ff8c42;
    }
    
    /* Multi-select and tag input styles */
    .multi-select-container {
      position: relative;
    }
    
    .multi-select-dropdown {
      position: relative;
    }
    
    .multi-select-input {
      min-height: 38px;
      padding: 0.25rem 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      align-items: center;
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      background-color: var(--card-bg);
      cursor: text;
    }
    
    .multi-select-input:focus-within {
      border-color: #f4623a;
      box-shadow: 0 0 0 0.2rem rgba(244, 98, 58, 0.25);
      outline: none;
    }
    
    body.dark-mode .multi-select-input:focus-within {
      border-color: #ff8c42;
      box-shadow: 0 0 0 0.2rem rgba(255, 140, 66, 0.25);
    }
    
    .tag-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background-color: var(--section-bg-light);
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      font-size: 0.875rem;
      color: var(--text-color);
    }
    
    .tag-badge .tag-remove {
      cursor: pointer;
      color: var(--text-muted);
      font-weight: bold;
      padding-left: 0.25rem;
    }
    
    .tag-badge .tag-remove:hover {
      color: #dc3545;
    }
    
    /* Action buttons in table */
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }
    
    .btn-action {
      background: none;
      border: none;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
      border-radius: 0.25rem;
    }
    
    .btn-action:hover {
      background-color: var(--section-bg-light);
      transform: scale(1.1);
    }
    
    .btn-edit:hover {
      color: #f4623a;
    }
    
    body.dark-mode .btn-edit:hover {
      color: #ff8c42;
    }
    
    .btn-delete:hover {
      color: #dc3545;
    }
    
    .btn-action i {
      font-size: 0.9rem;
    }
    
    .tag-input {
      border: none;
      background: transparent;
      outline: none;
      flex: 1;
      min-width: 100px;
      color: var(--text-color);
      font-size: 0.9rem;
    }
    
    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 0.25rem 0.25rem;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      display: none;
    }
    
    .suggestions-dropdown.show {
      display: block;
    }
    
    .suggestion-item {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      color: var(--text-color);
      border-bottom: 1px solid var(--border-color);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-item:hover {
      background-color: var(--section-bg-light);
    }
    
    .suggestion-item.selected {
      background-color: rgba(244, 98, 58, 0.1);
    }
    
    body.dark-mode .suggestion-item.selected {
      background-color: rgba(255, 140, 66, 0.1);
    }
    
    .alert {
      border-radius: 0.25rem;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
    }
    
    .alert-success {
      background-color: rgba(40, 167, 69, 0.1);
      border-color: #28a745;
      color: #28a745;
    }
    
    .alert-danger {
      background-color: rgba(220, 53, 69, 0.1);
      border-color: #dc3545;
      color: #dc3545;
    }
    
    .inventory-table-wrapper {
      overflow-x: auto;
      background-color: var(--card-bg);
      border-radius: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .inventory-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      margin: 0;
    }
    
    .inventory-table thead {
      background-color: var(--section-bg-light);
    }
    
    .inventory-table th {
      padding: 1rem 0.75rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-color);
      border-bottom: 2px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: var(--section-bg-light);
    }
    
    .inventory-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-color);
      vertical-align: top;
    }
    
    .inventory-table tbody tr {
      transition: background-color 0.2s ease;
    }
    
    .inventory-table tbody tr:hover {
      background-color: var(--section-bg-light);
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
      border: 1px solid;
      white-space: nowrap;
    }
    
    .status-Available {
      border-color: #2ecc71;
      color: #2ecc71;
      background-color: rgba(46, 204, 113, 0.1);
    }
    
    .status-In\ Use {
      border-color: #3498db;
      color: #3498db;
      background-color: rgba(52, 152, 219, 0.1);
    }
    
    
    .loading-message {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }
    
    .loading-message i {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #f4623a;
      animation: spin 1s linear infinite;
    }
    
    body.dark-mode .loading-message i {
      color: #ff8c42;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .no-results {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }
    
    @media (max-width: 767.98px) {
      .inventory-section {
        margin-top: 80px;
        padding: 1rem 0;
      }
      
      .inventory-filters {
        flex-direction: column;
      }
      
      .inventory-filters input,
      .inventory-filters select {
        width: 100%;
      }
      
      .inventory-actions {
        margin-bottom: 1rem;
      }
      
      .btn-export span,
      .btn-home span {
        display: none;
      }
      
      .inventory-table {
        font-size: 0.8rem;
      }
      
      .inventory-table th,
      .inventory-table td {
        padding: 0.5rem 0.4rem;
      }
    }
  </style>
</head>

<body id="page-top">
  <script>
    if (localStorage.getItem('darkMode') === 'enabled') {
      document.body.classList.add('dark-mode');
    }
  </script>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top py-3" id="mainNav" style="background-color: #fff; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);">
    <div class="container">
      <a class="navbar-brand js-scroll-trigger" href="../">Samuel Lamb</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto my-2 my-lg-0">
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="../#about">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="../#skills">Skills</a>
          </li>
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="../#projects">Projects</a>
          </li>
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="../devblog/">Dev Blog</a>
          </li>
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="../#contact">Contact</a>
          </li>
          <li class="nav-item">
            <button id="darkModeToggle" class="btn" title="Toggle Dark Mode">
              <i class="fas fa-moon"></i>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Inventory Section -->
  <section class="page-section inventory-section" id="inventory">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-12">
          <div class="inventory-header text-center">
            <h1 class="mt-0">Electronics Inventory</h1>
            <hr class="divider my-4">
            <div class="inventory-actions justify-content-center">
              <a href="../" class="btn-home">
                <i class="fas fa-home"></i>
                <span>Home</span>
              </a>
              <button type="button" class="btn btn-add" data-toggle="modal" data-target="#addItemModal">
                <i class="fas fa-plus"></i>
                <span>Add Item</span>
              </button>
            </div>
          </div>

          <div class="inventory-filters">
            <input id="search" type="text" placeholder="Search name/model/tags…" class="form-control" />
            <select id="statusFilter" class="form-control">
              <option value="">All Statuses</option>
              <option value="Available">Available</option>
              <option value="In Use">In Use</option>
            </select>
            <button id="refreshBtn" class="btn-export" title="Refresh inventory data" style="margin-right: 10px;">
              <i class="fas fa-sync-alt"></i>
              <span>Refresh</span>
            </button>
            <button id="exportBtn" class="btn-export" title="Export filtered results to CSV">
              <i class="fas fa-download"></i>
              <span>Export CSV</span>
            </button>
          </div>

          <div class="inventory-table-wrapper">
            <table class="inventory-table" id="inventoryTable">
              <thead>
                <tr>
                  <th>Item ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Qty (Avail / Total)</th>
                  <th>Location</th>
                  <th>Currently Used In</th>
                  <th>Use Cases</th>
                  <th>Notes</th>
                  <th>AI Tags</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="11" class="loading-message">
                    <i class="fas fa-spinner"></i>
                    <div>Loading inventory...</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete <strong id="deleteItemName"></strong>?</p>
          <p class="text-danger"><small>This action cannot be undone.</small></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Item Modal -->
  <div class="modal fade add-item-modal" id="addItemModal" tabindex="-1" role="dialog" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addItemModalLabel">Add New Item</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <input type="hidden" id="editMode" value="false">
        <input type="hidden" id="editItemId" value="">
        <div class="modal-body">
          <div id="addItemAlert"></div>
          <form id="addItemForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="itemId">Item ID</label>
                <select class="form-control" id="itemId">
                  <option value="">-- Select Item ID --</option>
                  <option value="__OTHER__">Other / Add New</option>
                </select>
                <div class="other-input-wrapper" id="itemIdOtherWrapper">
                  <input type="text" class="form-control" id="itemIdOther" placeholder="Enter new Item ID (e.g., ELEC-001)">
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="itemName">Item Name <span class="text-danger">*</span></label>
                <select class="form-control" id="itemName" required>
                  <option value="">-- Select Item Name --</option>
                  <option value="__OTHER__">Other / Add New</option>
                </select>
                <div class="other-input-wrapper" id="itemNameOtherWrapper">
                  <input type="text" class="form-control" id="itemNameOther" placeholder="Enter new Item Name (e.g., Arduino Uno)" required>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="category">Category</label>
                <select class="form-control" id="category">
                  <option value="">-- Select Category --</option>
                  <option value="__OTHER__">Other / Add New</option>
                </select>
                <div class="other-input-wrapper" id="categoryOtherWrapper">
                  <input type="text" class="form-control" id="categoryOther" placeholder="Enter new Category (e.g., Microcontroller)">
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="model">Model / Version</label>
                <select class="form-control" id="model">
                  <option value="">-- Select Model / Version --</option>
                  <option value="__OTHER__">Other / Add New</option>
                </select>
                <div class="other-input-wrapper" id="modelOtherWrapper">
                  <input type="text" class="form-control" id="modelOther" placeholder="Enter new Model / Version (e.g., R3)">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="location">Location</label>
                <select class="form-control" id="location">
                  <option value="">-- Select Location --</option>
                  <option value="__OTHER__">Other / Add New</option>
                </select>
                <div class="other-input-wrapper" id="locationOtherWrapper">
                  <input type="text" class="form-control" id="locationOther" placeholder="Enter new Location (e.g., Lab A, Shelf 3)">
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label>Status</label>
                <div class="form-control-plaintext" style="color: var(--text-muted); font-style: italic;">
                  Automatically calculated from Quantity Available
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="qtyOwned">Quantity Owned</label>
                <input type="number" class="form-control" id="qtyOwned" value="1" min="1">
              </div>
              <div class="col-md-4 mb-3">
                <label for="qtyInUse">Quantity In Use</label>
                <input type="number" class="form-control" id="qtyInUse" value="0" min="0">
              </div>
              <div class="col-md-4 mb-3">
                <label for="qtyAvailable">Quantity Available</label>
                <input type="number" class="form-control" id="qtyAvailable" value="1" min="0">
              </div>
            </div>
            <div class="mb-3">
              <label for="currentlyUsedIn">Currently Used In</label>
              <div class="multi-select-container">
                <div class="multi-select-dropdown">
                  <div class="multi-select-input" id="currentlyUsedInInput" tabindex="0">
                    <input type="text" class="tag-input" id="currentlyUsedInTagInput" placeholder="Type to add project/use...">
                  </div>
                </div>
              </div>
              <small class="form-text text-muted">Add multiple projects or uses this item is currently part of (e.g., "Home Automation", "Weather Station")</small>
            </div>
            <div class="mb-3">
              <label for="useCases">Use Cases</label>
              <textarea class="form-control" id="useCases" rows="2" placeholder="Describe what this item is used for..."></textarea>
            </div>
            <div class="mb-3">
              <label for="notes">Notes</label>
              <textarea class="form-control" id="notes" rows="2" placeholder="Additional information (e.g., '1 of the modules is broken', condition notes, etc.)..."></textarea>
              <small class="form-text text-muted">Optional notes about the item's condition or any other relevant information</small>
            </div>
            <div class="mb-3">
              <label for="aiTags">AI Tags</label>
              <div class="multi-select-container">
                <div class="multi-select-dropdown">
                  <div class="multi-select-input" id="aiTagsInput" tabindex="0">
                    <input type="text" class="tag-input" id="aiTagsTagInput" placeholder="Type to add tags...">
                  </div>
                  <div class="suggestions-dropdown" id="aiTagsSuggestions"></div>
                </div>
              </div>
              <small class="form-text text-muted">Select or type tags for AI search. Suggestions appear from existing inventory.</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="submitItemBtn">
            <i class="fas fa-save"></i> <span id="submitBtnText">Add Item</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-light py-5">
    <div class="container">
      <div class="small text-center text-muted">Samuel Thomas Lamb</div>
    </div>
  </footer>

  <!-- Bootstrap core JavaScript -->
  <script src="../vendor/jquery/jquery.min.js"></script>
  <script src="../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- Plugin JavaScript -->
  <script src="../vendor/jquery-easing/jquery.easing.min.js"></script>
  <script src="../vendor/magnific-popup/jquery.magnific-popup.min.js"></script>
  <!-- Custom scripts for this template -->
  <script src="../js/creative.min.js"></script>
  <script src="../js/dark-mode.js"></script>

  <script>
    // Google Sheets URLs
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSaWAFKETUji75820GD-rRupfpM3F97Z1Xy8AKsk2py_ToeMTr29du9t-VkAjTthBfZALgNbVLFbVFN/pub?gid=959564612&single=true&output=csv';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbys5ON4jaZvAFNw62M8msxBB6d2OHisuU15Duoq9AyBb1EEwV_dV1jCk8sFTVecYBu1/exec';

    // Proper CSV parser that handles quoted values
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      if (lines.length === 0) return [];
      
      // Parse CSV line handling quoted values
      function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              // Escaped quote
              current += '"';
              i++; // Skip next quote
            } else {
              // Toggle quote state
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            // End of field
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        
        // Add last field
        result.push(current.trim());
        return result;
      }
      
      // Parse headers
      const headers = parseCSVLine(lines[0]).map(h => h.replace(/^"|"$/g, '').trim());
      
      // Parse rows
      const rows = lines.slice(1).map(line => {
        const cols = parseCSVLine(line).map(col => col.replace(/^"|"$/g, '').trim());
        const obj = {};
        headers.forEach((h, i) => {
          obj[h] = cols[i] || '';
        });
        return obj;
      });
      
      return rows;
    }

    let inventoryData = [];

    // Extract unique values from inventory data for dropdowns
    function getUniqueValues(fieldName) {
      const values = new Set();
      inventoryData.forEach(item => {
        const value = item[fieldName];
        if (value && value.trim() !== '') {
          values.add(value.trim());
        }
      });
      return Array.from(values).sort();
    }

    // Extract all AI tags from inventory (comma-separated, split them)
    function getAllAITags() {
      const tags = new Set();
      inventoryData.forEach(item => {
        const tagString = item['AI Tags'] || '';
        if (tagString.trim() !== '') {
          tagString.split(',').forEach(tag => {
            const trimmed = tag.trim().toLowerCase();
            if (trimmed) {
              tags.add(trimmed);
            }
          });
        }
      });
      return Array.from(tags).sort();
    }

    // Common AI tags that might be useful
    const commonAITags = [
      'microcontroller', 'arduino', 'esp32', 'esp8266', 'raspberry pi', 'iot',
      'sensors', 'wifi', 'bluetooth', 'usb', 'development board', 'prototyping',
      'electronics', 'automation', 'robotics', 'power supply', 'cable', 'connector',
      'display', 'led', 'motor', 'servo', 'relay', 'transistor', 'resistor',
      'capacitor', 'breadboard', 'jumper wires', 'shield', 'module', 'breakout',
      'programming', 'debugging', 'testing', 'home automation', 'embedded'
    ];

    // Get all suggested AI tags (from inventory + common tags)
    function getSuggestedAITags() {
      const inventoryTags = getAllAITags();
      const allTags = new Set([...commonAITags, ...inventoryTags]);
      return Array.from(allTags).sort();
    }

    // Tag management for multi-select inputs
    function createTagManager(containerId, inputId, suggestions = null) {
      const container = document.getElementById(containerId);
      const input = document.getElementById(inputId);
      const tags = new Map(); // Map lowercase -> original case
      let selectedSuggestionIndex = -1;

      function addTag(tag) {
        const trimmed = tag.trim();
        if (!trimmed) return;
        
        const lowerTag = trimmed.toLowerCase();
        if (tags.has(lowerTag)) return;
        
        tags.set(lowerTag, trimmed); // Store original case
        renderTags();
        input.value = '';
        hideSuggestions();
      }

      function removeTag(tag) {
        tags.delete(tag.toLowerCase());
        renderTags();
      }

      function renderTags() {
        const tagInput = container.querySelector('.tag-input');
        const existingTags = container.querySelectorAll('.tag-badge');
        existingTags.forEach(tag => tag.remove());

        tags.forEach((originalTag, lowerTag) => {
          const badge = document.createElement('span');
          badge.className = 'tag-badge';
          badge.innerHTML = `
            <span>${escapeHtml(originalTag)}</span>
            <span class="tag-remove" data-tag="${escapeHtml(lowerTag)}">×</span>
          `;
          badge.querySelector('.tag-remove').addEventListener('click', (e) => {
            e.stopPropagation();
            removeTag(e.target.dataset.tag);
          });
          container.insertBefore(badge, tagInput);
        });
      }

      function showSuggestions(filter = '') {
        if (!suggestions) return;
        
        const suggestionsEl = document.getElementById('aiTagsSuggestions');
        if (!suggestionsEl) return;

        const filtered = suggestions.filter(s => 
          s.toLowerCase().includes(filter.toLowerCase()) && 
          !tags.has(s.toLowerCase())
        );

        if (filtered.length === 0) {
          suggestionsEl.classList.remove('show');
          return;
        }

        suggestionsEl.innerHTML = filtered.slice(0, 10).map((s, idx) => 
          `<div class="suggestion-item" data-value="${escapeHtml(s)}" data-index="${idx}">${escapeHtml(s)}</div>`
        ).join('');

        suggestionsEl.querySelectorAll('.suggestion-item').forEach((item, idx) => {
          item.addEventListener('click', () => {
            addTag(item.dataset.value);
            selectedSuggestionIndex = -1;
          });
        });

        suggestionsEl.classList.add('show');
        selectedSuggestionIndex = -1;
      }

      function hideSuggestions() {
        const suggestionsEl = document.getElementById('aiTagsSuggestions');
        if (suggestionsEl) {
          suggestionsEl.classList.remove('show');
        }
        selectedSuggestionIndex = -1;
      }

      function navigateSuggestions(direction) {
        const suggestionsEl = document.getElementById('aiTagsSuggestions');
        if (!suggestionsEl || !suggestionsEl.classList.contains('show')) return;

        const items = suggestionsEl.querySelectorAll('.suggestion-item');
        if (items.length === 0) return;

        if (selectedSuggestionIndex >= 0) {
          items[selectedSuggestionIndex].classList.remove('selected');
        }

        if (direction === 'down') {
          selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, items.length - 1);
        } else if (direction === 'up') {
          selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, 0);
        }

        if (selectedSuggestionIndex >= 0) {
          items[selectedSuggestionIndex].classList.add('selected');
          items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
        }
      }

      function selectCurrentSuggestion() {
        if (selectedSuggestionIndex < 0) return;
        const suggestionsEl = document.getElementById('aiTagsSuggestions');
        if (!suggestionsEl) return;
        const item = suggestionsEl.querySelector(`[data-index="${selectedSuggestionIndex}"]`);
        if (item) {
          addTag(item.dataset.value);
        }
      }

      // Event handlers
      input.addEventListener('input', (e) => {
        const value = e.target.value;
        if (value.includes(',')) {
          const parts = value.split(',');
          parts.slice(0, -1).forEach(part => addTag(part));
          input.value = parts[parts.length - 1];
        }
        if (suggestions) {
          showSuggestions(value);
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedSuggestionIndex >= 0) {
            selectCurrentSuggestion();
          } else if (input.value.trim()) {
            addTag(input.value);
          }
        } else if (e.key === 'Backspace' && input.value === '' && tags.size > 0) {
          const lastTag = Array.from(tags)[tags.size - 1];
          removeTag(lastTag);
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          navigateSuggestions('down');
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          navigateSuggestions('up');
        } else if (e.key === 'Escape') {
          hideSuggestions();
        }
      });

      container.addEventListener('click', () => {
        input.focus();
      });

      // Hide suggestions when clicking outside
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          hideSuggestions();
        }
      });

      return {
        addTag,
        removeTag,
        getTags: () => Array.from(tags.values()), // Return original case values
        clearTags: () => {
          tags.clear();
          renderTags();
        }
      };
    }

    let currentlyUsedInManager = null;
    let aiTagsManager = null;

    // Populate dropdown options
    function populateDropdowns() {
      // Item IDs
      const itemIdSelect = document.getElementById('itemId');
      if (!itemIdSelect) {
        console.warn('Item ID select not found, skipping dropdown population');
        return;
      }
      
      const itemIds = getUniqueValues('Item ID');
      itemIds.forEach(id => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = id;
        const otherOption = itemIdSelect.querySelector('option[value="__OTHER__"]');
        if (otherOption) {
          itemIdSelect.insertBefore(option, otherOption);
        } else {
          itemIdSelect.appendChild(option);
        }
      });

      // Item Names
      const itemNameSelect = document.getElementById('itemName');
      if (itemNameSelect) {
        const itemNames = getUniqueValues('Item Name');
        itemNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          const otherOption = itemNameSelect.querySelector('option[value="__OTHER__"]');
          if (otherOption) {
            itemNameSelect.insertBefore(option, otherOption);
          } else {
            itemNameSelect.appendChild(option);
          }
        });
      }

      // Categories
      const categorySelect = document.getElementById('category');
      if (categorySelect) {
        const categories = getUniqueValues('Category');
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          const otherOption = categorySelect.querySelector('option[value="__OTHER__"]');
          if (otherOption) {
            categorySelect.insertBefore(option, otherOption);
          } else {
            categorySelect.appendChild(option);
          }
        });
      }

      // Models/Versions
      const modelSelect = document.getElementById('model');
      if (modelSelect) {
        const models = getUniqueValues('Model / Version');
        models.forEach(model => {
          const option = document.createElement('option');
          option.value = model;
          option.textContent = model;
          const otherOption = modelSelect.querySelector('option[value="__OTHER__"]');
          if (otherOption) {
            modelSelect.insertBefore(option, otherOption);
          } else {
            modelSelect.appendChild(option);
          }
        });
      }

      // Locations
      const locationSelect = document.getElementById('location');
      if (locationSelect) {
        const locations = getUniqueValues('Location');
        locations.forEach(loc => {
          const option = document.createElement('option');
          option.value = loc;
          option.textContent = loc;
          const otherOption = locationSelect.querySelector('option[value="__OTHER__"]');
          if (otherOption) {
            locationSelect.insertBefore(option, otherOption);
          } else {
            locationSelect.appendChild(option);
          }
        });
      }

      // Initialize tag managers after dropdowns are populated (only if modal elements exist)
      if (!currentlyUsedInManager && document.getElementById('currentlyUsedInInput')) {
        try {
          currentlyUsedInManager = createTagManager('currentlyUsedInInput', 'currentlyUsedInTagInput');
        } catch (error) {
          console.error('Error initializing currentlyUsedInManager:', error);
        }
      }
      
      if (!aiTagsManager && document.getElementById('aiTagsInput')) {
        try {
          const suggestions = getSuggestedAITags();
          aiTagsManager = createTagManager('aiTagsInput', 'aiTagsTagInput', suggestions);
        } catch (error) {
          console.error('Error initializing aiTagsManager:', error);
        }
      }
    }

    async function loadInventory() {
      try {
        const res = await fetch(SHEET_CSV_URL);
        if (!res.ok) {
          throw new Error('Failed to load inventory data');
        }
        const text = await res.text();
        console.log('CSV data received, length:', text.length);
        inventoryData = parseCSV(text);
        console.log('Parsed inventory data:', inventoryData.length, 'items');
        
        try {
          renderTable();
        } catch (error) {
          console.error('Error rendering table:', error);
          throw error;
        }
        
        try {
          populateDropdowns(); // Populate dropdowns after loading data
        } catch (error) {
          console.error('Error populating dropdowns:', error);
          // Don't throw - dropdowns are not critical for display
        }
      } catch (error) {
        console.error('Error loading inventory:', error);
        console.error('Error stack:', error.stack);
        const tbody = document.querySelector('#inventoryTable tbody');
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="11" class="no-results">
                <i class="fas fa-exclamation-triangle"></i>
                <div>Error loading inventory data: ${error.message}</div>
                <div style="margin-top: 1rem; font-size: 0.8rem;">Check console for details.</div>
              </td>
            </tr>
          `;
        }
      }
    }

    function renderTable() {
      const tbody = document.querySelector('#inventoryTable tbody');
      tbody.innerHTML = '';

      const search = document.getElementById('search').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      const filtered = inventoryData.filter(row => {
        const name = (row['Item Name'] || '').toLowerCase();
        const model = (row['Model / Version'] || '').toLowerCase();
        const tags = (row['AI Tags'] || '').toLowerCase();
        // Calculate status from quantity available
        const qtyAvail = parseInt(row['Quantity Available'] || '0');
        const status = qtyAvail === 0 ? 'In Use' : 'Available';

        const matchesSearch =
          !search ||
          name.includes(search) ||
          model.includes(search) ||
          tags.includes(search);

        const matchesStatus =
          !statusFilter || status === statusFilter;

        return matchesSearch && matchesStatus;
      });

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="11" class="no-results">
              <i class="fas fa-search"></i>
              <div>No items found matching your criteria.</div>
            </td>
          </tr>
        `;
        return;
      }

      for (const row of filtered) {
        const tr = document.createElement('tr');

        const itemId = row['Item ID'] || '';
        const qtyOwned = row['Quantity Owned'] || '';
        const qtyAvail = parseInt(row['Quantity Available'] || '0');
        // Calculate status automatically: if qty available is 0, it's "In Use", otherwise "Available"
        const status = qtyAvail === 0 ? 'In Use' : 'Available';

        // Escape data for use in onclick attributes
        const rowJson = JSON.stringify(row).replace(/"/g, '&quot;');
        const itemNameEscaped = escapeHtml(row['Item Name'] || '').replace(/'/g, "&#39;");
        
        tr.innerHTML = `
          <td>${escapeHtml(itemId)}</td>
          <td>${escapeHtml(row['Item Name'] || '')}</td>
          <td>${escapeHtml(row['Category'] || '')}</td>
          <td>
            <span class="status-badge status-${status.replace(/\s/g, '\\ ')}">${escapeHtml(status)}</span>
          </td>
          <td>${escapeHtml(qtyAvail)} / ${escapeHtml(qtyOwned)}</td>
          <td>${escapeHtml(row['Location'] || '')}</td>
          <td>${escapeHtml(row['Currently Used In'] || '')}</td>
          <td>${escapeHtml(row['Use Cases'] || '')}</td>
          <td>${escapeHtml(row['Notes'] || '')}</td>
          <td>${escapeHtml(row['AI Tags'] || '')}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-action btn-edit" onclick="editItem(${rowJson})" title="Edit item">
                <i class="fas fa-pencil-alt"></i>
              </button>
              <button class="btn-action btn-delete" onclick="confirmDeleteItem('${escapeHtml(itemId).replace(/'/g, "\\'")}', '${itemNameEscaped}')" title="Delete item">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Get currently filtered data
    function getFilteredData() {
      const search = document.getElementById('search').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      return inventoryData.filter(row => {
        const name = (row['Item Name'] || '').toLowerCase();
        const model = (row['Model / Version'] || '').toLowerCase();
        const tags = (row['AI Tags'] || '').toLowerCase();
        // Calculate status from quantity available
        const qtyAvail = parseInt(row['Quantity Available'] || '0');
        const status = qtyAvail === 0 ? 'In Use' : 'Available';

        const matchesSearch =
          !search ||
          name.includes(search) ||
          model.includes(search) ||
          tags.includes(search);

        const matchesStatus =
          !statusFilter || status === statusFilter;

        return matchesSearch && matchesStatus;
      });
    }

    // Export filtered data to CSV
    function exportToCSV() {
      const filtered = getFilteredData();
      
      if (filtered.length === 0) {
        alert('No data to export. Please adjust your filters.');
        return;
      }

      // Get all unique headers from the data
      const allHeaders = new Set();
      filtered.forEach(row => {
        Object.keys(row).forEach(key => allHeaders.add(key));
      });
      const headers = Array.from(allHeaders);

      // Create CSV content
      const csvRows = [];
      
      // Add header row
      csvRows.push(headers.map(h => escapeCSVField(h)).join(','));

      // Add data rows
      filtered.forEach(row => {
        const values = headers.map(header => {
          const value = row[header] || '';
          return escapeCSVField(value);
        });
        csvRows.push(values.join(','));
      });

      const csvContent = csvRows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `inventory_export_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Escape CSV field (handle commas, quotes, newlines)
    function escapeCSVField(field) {
      if (field === null || field === undefined) {
        return '';
      }
      const stringField = String(field);
      // If field contains comma, quote, or newline, wrap in quotes and escape quotes
      if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
        return '"' + stringField.replace(/"/g, '""') + '"';
      }
      return stringField;
    }

    // Event listeners
    document.getElementById('search').addEventListener('input', renderTable);
    document.getElementById('statusFilter').addEventListener('change', renderTable);
    document.getElementById('exportBtn').addEventListener('click', exportToCSV);
    
    // Refresh button to reload inventory data
    document.getElementById('refreshBtn').addEventListener('click', async function() {
      const btn = this;
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Refreshing...</span>';
      
      try {
        await loadInventory();
        btn.innerHTML = '<i class="fas fa-check"></i> <span>Refreshed!</span>';
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }, 2000);
      } catch (error) {
        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Error</span>';
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }, 2000);
      }
    });

    // If URL has ?id=ITEMID, auto-filter search box to that ID
    function applyIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) return;
      const search = document.getElementById('search');
      search.value = id;
      renderTable();
    }

    // Add item to Google Sheets using form submission to avoid CORS
    function addItem(itemData) {
      return new Promise((resolve, reject) => {
        // Show loading state
        const submitBtn = document.getElementById('submitItemBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

        // Create a hidden form for submission (avoids CORS)
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = WEB_APP_URL;
        form.target = 'hiddenIframe';
        form.style.display = 'none';

        // Create hidden iframe to receive response
        let iframe = document.getElementById('hiddenIframe');
        if (!iframe) {
          iframe = document.createElement('iframe');
          iframe.id = 'hiddenIframe';
          iframe.name = 'hiddenIframe';
          iframe.style.display = 'none';
          document.body.appendChild(iframe);
        }

        // Check if edit mode
        const editMode = document.getElementById('editMode').value === 'true';
        const editItemId = document.getElementById('editItemId').value;
        
        // Add action field
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = editMode ? 'update' : 'add';
        form.appendChild(actionInput);
        
        // If edit mode, add the original Item ID for lookup
        if (editMode && editItemId) {
          const originalIdInput = document.createElement('input');
          originalIdInput.type = 'hidden';
          originalIdInput.name = 'originalItemId';
          originalIdInput.value = editItemId;
          form.appendChild(originalIdInput);
        }
        
        // Add all form fields (Google Apps Script receives these as form parameters)
        // The script should access them via e.parameter['Item Name'], etc.
        Object.keys(itemData).forEach(key => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = itemData[key] || '';
          form.appendChild(input);
        });
        
        // Also send as JSON in a single field for easier parsing
        const jsonInput = document.createElement('input');
        jsonInput.type = 'hidden';
        jsonInput.name = 'jsonData';
        jsonInput.value = JSON.stringify(itemData);
        form.appendChild(jsonInput);

        // Add form to body and submit
        document.body.appendChild(form);

        // Set up response handler
        let responseReceived = false;
        const timeout = setTimeout(() => {
          if (!responseReceived) {
            responseReceived = true;
            document.body.removeChild(form);
            showAlert('Request timed out. The item may have been added - please refresh to check.', 'danger');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            reject(new Error('Timeout'));
          }
        }, 10000); // 10 second timeout

        // Listen for iframe load (response received)
        iframe.onload = function() {
          if (!responseReceived) {
            responseReceived = true;
            clearTimeout(timeout);
            
            // Try to detect errors by checking iframe content or URL
            let hasError = false;
            try {
              // Check if we can access iframe content (may be blocked by CORS)
              const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
              const bodyText = iframeDoc.body ? iframeDoc.body.innerText.toLowerCase() : '';
              
              // Check for common error indicators
              if (bodyText.includes('403') || 
                  bodyText.includes('forbidden') || 
                  bodyText.includes('error') ||
                  bodyText.includes('permission denied')) {
                hasError = true;
              }
              
              // Check iframe URL for error indicators
              try {
                const iframeUrl = iframe.contentWindow.location.href;
                if (iframeUrl.includes('error') || iframeUrl.includes('403')) {
                  hasError = true;
                }
              } catch (e) {
                // Can't access iframe URL due to CORS - that's okay
              }
            } catch (e) {
              // Can't access iframe content due to CORS - assume success for now
              // The user can manually refresh to see if the change was applied
            }
            
            document.body.removeChild(form);

            if (hasError) {
              // Show error message about 403/permissions
              showAlert('Error: Permission denied (403). Your Google Apps Script may need to be redeployed or permissions updated. The change may not have been saved - please check your Google Sheet and use the Refresh button to sync.', 'danger');
              submitBtn.disabled = false;
              submitBtn.innerHTML = originalText;
              reject(new Error('403 Forbidden'));
              return;
            }

            // Assume success if iframe loads (Google Apps Script redirects on success)
            // Wait a moment for the script to process, then reload inventory
            setTimeout(async () => {
              const isEditMode = document.getElementById('editMode').value === 'true';
              const message = isEditMode ? 'Item updated successfully! Reloading inventory...' : 'Item added successfully! Reloading inventory...';
              showAlert(message, 'success');
              
              // Reload inventory after a short delay (this will refresh dropdowns)
              setTimeout(async () => {
                await loadInventory(); // This will repopulate dropdowns with new data
                // Close modal and reset form
                $('#addItemModal').modal('hide');
                resetAddItemForm();
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                // Reset edit mode
                const editModeEl = document.getElementById('editMode');
                const editItemIdEl = document.getElementById('editItemId');
                const modalLabelEl = document.getElementById('addItemModalLabel');
                const submitBtnTextEl = document.getElementById('submitBtnText');
                
                if (editModeEl) editModeEl.value = 'false';
                if (editItemIdEl) editItemIdEl.value = '';
                if (modalLabelEl) modalLabelEl.textContent = 'Add New Item';
                if (submitBtnTextEl) submitBtnTextEl.textContent = 'Add Item';
              }, 1000);
              
              resolve(true);
            }, 500);
          }
        };

        // Handle iframe errors
        iframe.onerror = function() {
          if (!responseReceived) {
            responseReceived = true;
            clearTimeout(timeout);
            document.body.removeChild(form);
            showAlert('Error submitting item. Please try again.', 'danger');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            reject(new Error('Submission failed'));
          }
        };

        // Submit the form
        form.submit();
      });
    }

    // Show alert message in modal
    function showAlert(message, type) {
      const alertDiv = document.getElementById('addItemAlert');
      alertDiv.innerHTML = `<div class="alert alert-${type}" role="alert">${escapeHtml(message)}</div>`;
      // Scroll to top of modal
      alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Handle "Other" selection in dropdowns
    function setupDropdownHandlers() {
      const dropdowns = [
        { select: 'itemId', other: 'itemIdOther', wrapper: 'itemIdOtherWrapper' },
        { select: 'itemName', other: 'itemNameOther', wrapper: 'itemNameOtherWrapper', required: true },
        { select: 'category', other: 'categoryOther', wrapper: 'categoryOtherWrapper' },
        { select: 'model', other: 'modelOther', wrapper: 'modelOtherWrapper' },
        { select: 'location', other: 'locationOther', wrapper: 'locationOtherWrapper' }
      ];

      dropdowns.forEach(({ select, other, wrapper, required }) => {
        const selectEl = document.getElementById(select);
        const otherInput = document.getElementById(other);
        const wrapperEl = document.getElementById(wrapper);

        selectEl.addEventListener('change', function() {
          if (this.value === '__OTHER__') {
            wrapperEl.classList.add('show');
            if (required) {
              otherInput.required = true;
            }
            otherInput.focus();
          } else {
            wrapperEl.classList.remove('show');
            otherInput.value = '';
            if (required) {
              otherInput.required = false;
            }
          }
        });
      });
    }

    // Get value from dropdown or "Other" input
    function getFieldValue(fieldId, otherFieldId) {
      const select = document.getElementById(fieldId);
      if (select.value === '__OTHER__') {
        return document.getElementById(otherFieldId).value.trim();
      }
      return select.value.trim();
    }

    // Handle form submission
    document.getElementById('submitItemBtn').addEventListener('click', function() {
      const form = document.getElementById('addItemForm');
      
      // Collect form data (using dropdowns or "Other" inputs)
      const itemData = {
        'Item ID': getFieldValue('itemId', 'itemIdOther'),
        'Item Name': getFieldValue('itemName', 'itemNameOther'),
        'Category': getFieldValue('category', 'categoryOther'),
        'Model / Version': getFieldValue('model', 'modelOther'),
        'Quantity Owned': document.getElementById('qtyOwned').value || '1',
        'Quantity In Use': document.getElementById('qtyInUse').value || '0',
        'Quantity Available': document.getElementById('qtyAvailable').value || document.getElementById('qtyOwned').value || '1',
        'Location': getFieldValue('location', 'locationOther'),
        'Currently Used In': currentlyUsedInManager ? currentlyUsedInManager.getTags().join(', ') : '',
        'Use Cases': document.getElementById('useCases').value.trim(),
        'Notes': document.getElementById('notes').value.trim(),
        'AI Tags': aiTagsManager ? aiTagsManager.getTags().join(', ') : ''
      };

      // Calculate status automatically based on Quantity Available
      const qtyAvailable = parseInt(itemData['Quantity Available'] || '0');
      itemData['Status'] = qtyAvailable === 0 ? 'In Use' : 'Available';

      // Validate that Item Name is provided
      if (!itemData['Item Name']) {
        showAlert('Item Name is required', 'danger');
        // Focus on the appropriate field
        const itemNameSelect = document.getElementById('itemName');
        if (itemNameSelect.value === '__OTHER__') {
          document.getElementById('itemNameOther').focus();
        } else {
          itemNameSelect.focus();
        }
        return;
      }

      // Submit (using form submission to avoid CORS)
      addItem(itemData).catch(error => {
        console.error('Error adding item:', error);
        // Error already handled in addItem function
      });
    });

    // Auto-calculate available quantity when owned or in-use changes
    document.getElementById('qtyOwned').addEventListener('input', function() {
      const owned = parseInt(this.value) || 0;
      const inUse = parseInt(document.getElementById('qtyInUse').value) || 0;
      const available = Math.max(0, owned - inUse);
      document.getElementById('qtyAvailable').value = available;
    });

    document.getElementById('qtyInUse').addEventListener('input', function() {
      const owned = parseInt(document.getElementById('qtyOwned').value) || 0;
      const inUse = parseInt(this.value) || 0;
      const available = Math.max(0, owned - inUse);
      document.getElementById('qtyAvailable').value = available;
    });

    // Reset add item form
    function resetAddItemForm() {
      document.getElementById('addItemForm').reset();
      document.getElementById('addItemAlert').innerHTML = '';
      document.getElementById('qtyOwned').value = '1';
      document.getElementById('qtyInUse').value = '0';
      document.getElementById('qtyAvailable').value = '1';
      document.getElementById('notes').value = '';
      
      // Reset all "Other" input wrappers
      document.querySelectorAll('.other-input-wrapper').forEach(wrapper => {
        wrapper.classList.remove('show');
      });
      
      // Clear all "Other" inputs
      document.querySelectorAll('[id$="Other"]').forEach(input => {
        if (input.tagName === 'INPUT') {
          input.value = '';
          input.required = false;
        }
      });
      
      // Reset dropdowns
      document.getElementById('itemId').value = '';
      document.getElementById('itemName').value = '';
      document.getElementById('category').value = '';
      document.getElementById('model').value = '';
      document.getElementById('location').value = '';
      
      // Clear tag managers
      if (currentlyUsedInManager) {
        currentlyUsedInManager.clearTags();
      }
      if (aiTagsManager) {
        aiTagsManager.clearTags();
      }
      
      // Reset edit mode
      const editModeEl = document.getElementById('editMode');
      const editItemIdEl = document.getElementById('editItemId');
      const modalLabelEl = document.getElementById('addItemModalLabel');
      const submitBtnTextEl = document.getElementById('submitBtnText');
      
      if (editModeEl) editModeEl.value = 'false';
      if (editItemIdEl) editItemIdEl.value = '';
      if (modalLabelEl) modalLabelEl.textContent = 'Add New Item';
      if (submitBtnTextEl) submitBtnTextEl.textContent = 'Add Item';
    }

    // Reset form when modal is closed
    $('#addItemModal').on('hidden.bs.modal', function() {
      resetAddItemForm();
      const submitBtn = document.getElementById('submitItemBtn');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Item';
    });

    // Setup dropdown handlers when modal is shown (after dropdowns are populated)
    $('#addItemModal').on('shown.bs.modal', function() {
      setupDropdownHandlers();
    });

    // Make functions global so they can be called from onclick handlers
    window.editItem = function(itemData) {
      // Set edit mode
      const editModeEl = document.getElementById('editMode');
      const editItemIdEl = document.getElementById('editItemId');
      const modalLabelEl = document.getElementById('addItemModalLabel');
      const submitBtnTextEl = document.getElementById('submitBtnText');
      
      if (editModeEl) editModeEl.value = 'true';
      if (editItemIdEl) editItemIdEl.value = itemData['Item ID'] || '';
      if (modalLabelEl) modalLabelEl.textContent = 'Edit Item';
      if (submitBtnTextEl) submitBtnTextEl.textContent = 'Save Changes';
      
      // Populate form fields
      setDropdownOrOther('itemId', 'itemIdOther', itemData['Item ID'] || '');
      setDropdownOrOther('itemName', 'itemNameOther', itemData['Item Name'] || '');
      setDropdownOrOther('category', 'categoryOther', itemData['Category'] || '');
      setDropdownOrOther('model', 'modelOther', itemData['Model / Version'] || '');
      setDropdownOrOther('location', 'locationOther', itemData['Location'] || '');
      
      const qtyOwnedEl = document.getElementById('qtyOwned');
      const qtyInUseEl = document.getElementById('qtyInUse');
      const qtyAvailableEl = document.getElementById('qtyAvailable');
      const useCasesEl = document.getElementById('useCases');
      const notesEl = document.getElementById('notes');
      
      if (qtyOwnedEl) qtyOwnedEl.value = itemData['Quantity Owned'] || '1';
      if (qtyInUseEl) qtyInUseEl.value = itemData['Quantity In Use'] || '0';
      if (qtyAvailableEl) qtyAvailableEl.value = itemData['Quantity Available'] || itemData['Quantity Owned'] || '1';
      if (useCasesEl) useCasesEl.value = itemData['Use Cases'] || '';
      if (notesEl) notesEl.value = itemData['Notes'] || '';
      
      // Populate tag fields
      if (currentlyUsedInManager) {
        currentlyUsedInManager.clearTags();
        const usedIn = itemData['Currently Used In'] || '';
        if (usedIn) {
          usedIn.split(',').forEach(tag => {
            if (tag.trim()) currentlyUsedInManager.addTag(tag.trim());
          });
        }
      }
      
      if (aiTagsManager) {
        aiTagsManager.clearTags();
        const tags = itemData['AI Tags'] || '';
        if (tags) {
          tags.split(',').forEach(tag => {
            if (tag.trim()) aiTagsManager.addTag(tag.trim());
          });
        }
      }
      
      // Show modal
      $('#addItemModal').modal('show');
    }
    
    // Helper function to set dropdown or show "Other" input
    function setDropdownOrOther(selectId, otherInputId, value) {
      const select = document.getElementById(selectId);
      const otherInput = document.getElementById(otherInputId);
      const wrapper = document.getElementById(otherInputId + 'Wrapper');
      
      if (!select) {
        console.warn(`Select element with id '${selectId}' not found`);
        return;
      }
      
      if (!value) {
        select.value = '';
        if (wrapper) wrapper.classList.remove('show');
        return;
      }
      
      // Check if value exists in dropdown
      let found = false;
      for (let option of select.options) {
        if (option.value === value) {
          select.value = value;
          if (wrapper) wrapper.classList.remove('show');
          found = true;
          break;
        }
      }
      
      if (!found && value) {
        // Set "Other" option and show input
        select.value = '__OTHER__';
        if (wrapper) wrapper.classList.add('show');
        if (otherInput) otherInput.value = value;
      } else if (!value) {
        select.value = '';
        wrapper.classList.remove('show');
        otherInput.value = '';
      }
    }
    
    window.confirmDeleteItem = function(itemId, itemName) {
      document.getElementById('deleteItemName').textContent = itemName || itemId;
      document.getElementById('confirmDeleteBtn').onclick = () => deleteItem(itemId);
      $('#deleteConfirmModal').modal('show');
    }
    
    // Delete item from Google Sheets
    function deleteItem(itemId) {
      const submitBtn = document.getElementById('confirmDeleteBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
      
      // Create form submission for delete
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = WEB_APP_URL;
      form.target = 'hiddenIframe';
      form.style.display = 'none';
      
      const actionInput = document.createElement('input');
      actionInput.type = 'hidden';
      actionInput.name = 'action';
      actionInput.value = 'delete';
      form.appendChild(actionInput);
      
      const idInput = document.createElement('input');
      idInput.type = 'hidden';
      idInput.name = 'Item ID';
      idInput.value = itemId;
      form.appendChild(idInput);
      
      let iframe = document.getElementById('hiddenIframe');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'hiddenIframe';
        iframe.name = 'hiddenIframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
      }
      
      document.body.appendChild(form);
      
      let responseReceived = false;
      const timeout = setTimeout(() => {
        if (!responseReceived) {
          responseReceived = true;
          document.body.removeChild(form);
          alert('Delete request timed out. Please refresh to check if item was deleted.');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }, 10000);
      
      iframe.onload = function() {
        if (!responseReceived) {
          responseReceived = true;
          clearTimeout(timeout);
          document.body.removeChild(form);
          
          setTimeout(async () => {
            $('#deleteConfirmModal').modal('hide');
            await loadInventory();
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }, 500);
        }
      };
      
      iframe.onerror = function() {
        if (!responseReceived) {
          responseReceived = true;
          clearTimeout(timeout);
          document.body.removeChild(form);
          alert('Error deleting item. Please try again.');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      };
      
      form.submit();
    }

    // Load inventory on page load
    loadInventory().then(applyIdFromURL);
  </script>
</body>

</html>

